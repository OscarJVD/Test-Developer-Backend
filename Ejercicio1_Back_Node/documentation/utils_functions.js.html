<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/functions.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/functions.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const isValidEmail = require('is-valid-email');
const isPhone = require('is-phone');
const isValidUsername = require('is-valid-username');
const cloudinary = require("cloudinary").v2;
const fs = require("fs");

cloudinary.config({
  cloud_name: process.env.CLOUD_NAME,
  api_key: process.env.CLNY_KEY,
  api_secret: process.env.CLNY_SECRET,
});

/**
 * @descrioption This function get all the collections on the database NoSql
*/

const getMyCollections = mongoose => new Promise((resolve, reject) => {
  try {
    mongoose.connection.db.listCollections().toArray().then(collections => {
      const names = collections.map(col => col.name);
      resolve(names);
    })

  } catch (error) {
    console.log(error)
    console.log(util.inspect(error))
  }
});

/**
 * @description This function validate if the email, phone or username is valid
 * @param {*} value
 * @returns {string}
 */
function isEmailTelOrUserName(value) {
  if (isValidEmail(value)) return 'email';
  if (isPhone(value)) return 'tel';
  if (isValidUsername(value)) return 'username';
  const userRegex = new RegExp("^[a-zA-Z0-9]+$");
  if (!userRegex.test(value)) return 'usernameerror';
  return 'error';
}

/**
 * @description this function get a random Integer
*/
function getRandomNum(min, max) {
  return parseInt(Math.random() * (max - min) + min);
}

/**
 * @description this function sort an object by key aphabetically
 * @param {object} object
 * @returns ordered object
 */
function sort(object) {
  // Don't try to sort things that aren't objects
  if (typeof object != "object") {
    return object;
  }

  // Don't sort arrays, but do sort their contents
  if (Array.isArray(object)) {
    object.forEach(function (entry, index) {
      object[index] = sort(entry);
    });
    return object;
  }

  console.log(object)
  // Sort the keys
  let newObject = {};
  if (object) {
    let keys = Object.keys(object);
    keys.sort(function (a, b) {
      let atype = typeof object[a],
        btype = typeof object[b],
        rv;
      if (atype !== btype &amp;&amp; (atype === "object" || btype === "object")) {
        // Non-objects before objects
        rv = atype === 'object' ? 1 : -1;
      } else {
        // Alphabetical within categories
        rv = a.localeCompare(b);
      }
      return rv;
    });

    // Create new object in the new order, sorting
    // its subordinate properties as necessary
    keys.forEach(function (key) {
      newObject[key] = sort(object[key]);
    });
  }
  return newObject;
}

/**
 * @description this function upload a image to cloudinary
*/
async function uploadToCloudinary(locaFilePath) {

  // locaFilePath: path of image which was just
  // uploaded to "uploads" folder

  var mainFolderName = "main";
  // filePathOnCloudinary: path of image we want
  // to set when it is uploaded to cloudinary
  var filePathOnCloudinary =
    mainFolderName + "/" + locaFilePath;

  return cloudinary.uploader
    .upload(locaFilePath, { public_id: filePathOnCloudinary })
    .then((result) => {

      // Image has been successfully uploaded on
      // cloudinary So we dont need local image 
      // file anymore
      // Remove file from local uploads folder
      fs.unlinkSync(locaFilePath);

      return {
        message: "Success",
        url: result.url,
      };
    })
    .catch((error) => {

      // Remove file from local uploads folder
      fs.unlinkSync(locaFilePath);
      return { message: "Fail" };
    });
}

/**
 * @description this function upload a image to cloudinary too
*/
const imageUpload = async (images) => {

  // console.log(images);
  let imgArr = []

  for (const item of images) {
    const formData = new FormData()

    // Configuraciones para guardar las imgs en CLOUDINARY
    formData.append('file', item)
    formData.append('upload_preset', process.env.CLOUD_UPDATE_PRESET)
    formData.append('cloud_name', process.env.CLOUD_NAME)

    const res = await fetch(process.env.CLOUD_API, {
      method: 'POST',
      body: formData
    })

    const data = await res.json()

    // console.log(data);

    imgArr.push({ public_id: data.public_id, url: data.secure_url })
  }

  // Guardar en cloudinary y a la vez consulta la API DE nuestra imágenes
  return imgArr
}

module.exports = { isEmailTelOrUserName, getRandomNum, sort, getMyCollections, uploadToCloudinary, imageUpload };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#auth">auth</a></li><li><a href="global.html#connectDB">connectDB</a></li><li><a href="global.html#createAccessToken">createAccessToken</a></li><li><a href="global.html#createRefreshToken">createRefreshToken</a></li><li><a href="global.html#getMyCollections">getMyCollections</a></li><li><a href="global.html#getRandomNum">getRandomNum</a></li><li><a href="global.html#imageUpload">imageUpload</a></li><li><a href="global.html#isEmailTelOrUserName">isEmailTelOrUserName</a></li><li><a href="global.html#sort">sort</a></li><li><a href="global.html#uploadToCloudinary">uploadToCloudinary</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Mon Jun 13 2022 15:50:41 GMT-0500 (hora estándar de Colombia)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
